æˆ‘æ˜¯ä¸€åè½¯ä»¶å·¥ç¨‹åº”å±Šæ¯•ä¸šç”Ÿï¼Œæ­£å‡†å¤‡åº”è˜å›½å†…å¤§å‚çš„åç«¯æš‘æœŸå®ä¹ ç”Ÿã€‚ä¸ºäº†å®Œå–„é¡¹ç›®ç»å†ï¼Œæˆ‘ä½¿ç”¨äº†golang fiberæ¡†æ¶ï¼Œå¼€å‘äº†ä¸€ä¸ªç®€æ˜“çš„åœ¨çº¿é‡‘èè¯åˆ¸äº¤æ˜“ç³»ç»Ÿã€‚å› ä¸ºæ˜¯ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼Œæˆ‘çš„å„ç§è®¾è®¡éƒ½æœ‰å¾…ä¼˜åŒ–æˆ–æ”¹æ­£ã€‚
é¡¹ç›®çš„ä¸»è¦éœ€æ±‚å·²ä»¥.mdçš„å½¢å¼å‘é€ï¼›é¡¹ç›®çš„æ¦‚è¿°å›¾ç‰‡å·²ä»¥.pngçš„å½¢å¼å‘é€ï¼›
é¡¹ç›®æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š
backend/
â”œâ”€â”€ bin/                   # ç¼–è¯‘è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ ebidsystem.exe        # å¯æ‰§è¡Œæ–‡ä»¶
â”‚   â”œâ”€â”€ logs                  # æ—¥å¿—ç›®å½•
â”‚   â”‚   â””â”€â”€service.log           # æ‰€æœ‰ä¿¡æ¯æ—¥å¿—
â”‚   â”œâ”€â”€ matchLog              # æ’®åˆé€»è¾‘æ—¥å¿—
â”‚   â””â”€â”€ .env                  # ç¯å¢ƒå˜é‡ï¼ˆç”±æ ¹ç›®å½•å¤åˆ¶è€Œæ¥ï¼‰
â”œâ”€â”€ config/                # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ config.go             # è¯»å–ç¯å¢ƒå˜é‡
â”œâ”€â”€ controllers/           # æ§åˆ¶å™¨ï¼ˆå¤„ç† HTTP è¯·æ±‚ï¼‰
â”‚   â”œâ”€â”€ auth.go               # æ³¨å†Œ/ç™»å½•/æ³¨é”€
â”‚   â”œâ”€â”€ client.go             # å®¢æˆ·ç›¸å…³åŠŸèƒ½
â”‚   â”œâ”€â”€ common.go             # å…¬å…±æ§åˆ¶å™¨ï¼ˆå¦‚å¯¹æ•°æ®åº“/JWT/é”™è¯¯çš„å¤„ç†ï¼‰
â”‚   â”œâ”€â”€ order.go              # è®¢å•åˆ›å»ºã€æŸ¥è¯¢ã€å–æ¶ˆ
â”‚   â”œâ”€â”€ sales.go              # é”€å”®ç›¸å…³åŠŸèƒ½ï¼ˆè‰ç¨¿ã€æäº¤å®¡æ‰¹ï¼‰
â”‚   â”œâ”€â”€ seller.go             # å–å®¶æˆæƒç®¡ç†
â”‚   â””â”€â”€ trader.go             # äº¤æ˜“å‘˜æˆæƒç®¡ç†
â”œâ”€â”€ middleware/            # ä¸­é—´ä»¶å®šä¹‰
â”‚   â”œâ”€â”€ auth.go               # è§’è‰²æƒé™æ ¡éªŒä¸­é—´ä»¶ï¼ˆå¦‚ SellerOnly, SalesOnlyï¼‰
â”‚   â”œâ”€â”€ jwt.go                # JWT è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ logging.go            # è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
â”œâ”€â”€ models/                # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ user.go               # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ order.go              # è®¢å•æ¨¡å‹
â”‚   â”œâ”€â”€ stock.go              # è‚¡ç¥¨æ¨¡å‹ï¼ˆæš‚ä¸å®ç°ï¼‰
â”‚   â”œâ”€â”€ trades.go             # æˆäº¤ä¿¡æ¯ï¼ˆæ’®åˆæˆåŠŸåï¼‰
â”‚   â””â”€â”€ authorization.go      # å–å®¶-é”€å”®æˆæƒæ¨¡å‹ï¼ˆå·²å®šä¹‰åœ¨ ./user.go ä¸­ï¼Œæš‚ä¸ç‹¬ç«‹å‡ºæ¥ï¼‰
â”œâ”€â”€ routes/                # è·¯ç”±å®šä¹‰
â”‚   â””â”€â”€ api.go                # API è·¯ç”±æ³¨å†Œ
â”œâ”€â”€ services/              # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ matching.go           # è®¢å•æ’®åˆå¼•æ“
â”‚   â””â”€â”€ order.go              # è®¢å•çŠ¶æ€ç®¡ç†
â”œâ”€â”€ .env                   # ç¯å¢ƒå˜é‡ï¼ˆå¼€å‘ç¯å¢ƒé…ç½®ï¼‰
â”œâ”€â”€ go.mod                 # Go æ¨¡å—ä¾èµ–
â”œâ”€â”€ go.sum                 # ä¾èµ–æ ¡éªŒ
â”œâ”€â”€ main.go                # åº”ç”¨å…¥å£ï¼ˆåˆå§‹åŒ–ã€å¯åŠ¨æœåŠ¡ï¼‰
â””â”€â”€ start.bat              # æ‰¹å¤„ç†æ–‡ä»¶ï¼ˆå–å¾—ç®¡ç†å‘˜æƒé™+æˆæƒé€šè¿‡é˜²ç«å¢™+ç¼–è¯‘+è¿è¡Œ+è¾“å‡ºæ—¥å¿—ï¼‰

å…¶ä¸­ï¼Œæˆ‘çš„ä¸»å‡½æ•°æ–‡ä»¶å¦‚ä¸‹ï¼š
package main

import (
	"fmt"
	"log"
	"os"
	"time"

	"github.com/champNoob/ebidsystem/backend/config"
	"github.com/champNoob/ebidsystem/backend/controllers"
	"github.com/champNoob/ebidsystem/backend/models"
	"github.com/champNoob/ebidsystem/backend/routes"
	"github.com/user2083251241/ebidsystem/middleware"
	"github.com/user2083251241/ebidsystem/services"

	"github.com/gofiber/fiber/v2"
	"github.com/gofiber/fiber/v2/middleware/cors"
	"github.com/gofiber/fiber/v2/middleware/logger"
	"github.com/gofiber/fiber/v2/middleware/recover"
	"github.com/joho/godotenv"
	"gorm.io/driver/mysql"
	"gorm.io/gorm"
)

func main() {
	// åŠ è½½ç¯å¢ƒå˜é‡ï¼š
	err := godotenv.Load(".env")
	if err != nil {
		log.Fatal("Error loading .env file")
	}
	// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼š
	dsn := config.Get("DB_DSN")
	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
	if err != nil {
		log.Fatalf("Failed to connect to database: %v", err)
	}
	// è‡ªåŠ¨è¿ç§»æ•°æ®åº“è¡¨ï¼š
	if err := db.AutoMigrate(
		&models.User{},
		&models.Order{},
		// &models.Stock{},
		&models.SellerSalesAuthorization{},
		&models.Trade{},
	); err != nil {
		log.Fatalf("Database migration failed: %v", err)
	}
	// åˆå§‹åŒ–Fiberåº”ç”¨ï¼š
	app := fiber.New()
	// æ³¨å†Œä¸­é—´ä»¶ï¼š
	app.Use(logger.New())                 //è¯·æ±‚æ—¥å¿—
	app.Use(recover.New())                //å¼‚å¸¸æ¢å¤
	app.Use(middleware.LoggingMiddleware) //è‡ªå®šä¹‰æ—¥å¿—ä¸­é—´ä»¶
	app.Use(cors.New(cors.Config{         //è·¨åŸŸè¯·æ±‚
		AllowOrigins: "*", // å…è®¸æ‰€æœ‰æ¥æº
		AllowMethods: "GET,POST,PUT,DELETE",
	}))
	// ä¾èµ–æ³¨å…¥ï¼ˆå°†æ•°æ®åº“å®ä¾‹ä¼ é€’ç»™æ§åˆ¶å™¨ï¼‰ï¼š
	controllers.InitDB(db)
	// æ³¨å†Œè·¯ç”±ï¼š
	routes.SetupRoutes(app)
	// å¯åŠ¨æ’®åˆå¼•æ“ï¼š
	go func() {
		ticker := time.NewTicker(10 * time.Second)
		for {
			services.MatchOrders(db, 10*time.Minute, 0.01)
			<-ticker.C
			if err := services.MatchOrders(db, 10*time.Minute, 0.0001); err != nil {
				log.Printf("æ’®åˆå¼•æ“é”™è¯¯: %v", err)
			}
		}
	}()
	// å¯åŠ¨æœåŠ¡å™¨ï¼š
	port := os.Getenv("PORT")
	if port == "" {
		port = "3000"
	}
	// è¾“å‡ºå¯åŠ¨ä¿¡æ¯ï¼š
	fmt.Printf("ğŸš€ Server started on port %s\n", port)
	if err := app.Listen("0.0.0.0:" + port); err != nil {
		log.Fatalf("Server startup failed: %v", err)
	}
}


æˆ‘çš„è·¯ç”±æ–‡ä»¶./route/api.goå¦‚ä¸‹ï¼š
package routes

import (
	"github.com/champNoob/ebidsystem/backend/config"
	"github.com/champNoob/ebidsystem/backend/controllers"
	"github.com/champNoob/ebidsystem/backend/middleware"
	jwtware "github.com/gofiber/contrib/jwt"
	"github.com/gofiber/fiber/v2"
	"github.com/gofiber/fiber/v2/middleware/cors"
)

func SetupRoutes(app *fiber.App) {
	// æ·»åŠ CORSä¸­é—´ä»¶ï¼ˆå¿…é¡»åœ¨è·¯ç”±å®šä¹‰å‰è°ƒç”¨ï¼‰
	app.Use(cors.New(cors.Config{
		AllowOrigins:     "http://192.168.1.100:8080", // æ›¿æ¢ä¸ºå‰ç«¯å®é™…IPå’Œç«¯å£
		AllowHeaders:     "Origin, Content-Type, Accept, Authorization",
		AllowMethods:     "GET, POST, PUT, DELETE, OPTIONS",
		AllowCredentials: true, // å…è®¸æºå¸¦Cookieæˆ–Authorizationå¤´
	}))
	// å…¬å…±è·¯ç”±ï¼š
	public := app.Group("/api")
	{
		public.Post("/register", controllers.Register)
		public.Post("/login", controllers.Login)
	}
	// JWT ä¸­é—´ä»¶åˆå§‹åŒ–ï¼š
	jwtMiddleware := jwtware.New(jwtware.Config{
		SigningKey: jwtware.SigningKey{
			Key: []byte(config.Get("JWT_SECRET")),
		},
	})
	// è®¤è¯è·¯ç”±ç»„ï¼š
	authenticated := app.Group("/api", jwtMiddleware)
	{
		// æ‰€æœ‰è®¤è¯ç”¨æˆ·å‡å¯è°ƒç”¨ï¼š
		authenticated.Post("/logout", controllers.Logout) // ç™»å‡º
		// å–å®¶è§’è‰²è·¯ç”±ç»„ï¼š
		seller := authenticated.Group("/seller", middleware.SellerOnly)
		{
			seller.Post("/orders", controllers.CreateSellOrder)                // åˆ›å»ºå–å‡ºè®¢å•
			seller.Put("/orders/:id", controllers.UpdateOrder)                 // ä¿®æ”¹è®¢å•
			seller.Delete("/orders/:id", controllers.CancelOrder)              // å•ä¸ªæ’¤å•
			seller.Post("/orders/batch-cancel", controllers.BatchCancelOrders) // æ‰¹é‡æ’¤å•
			seller.Get("/orders", controllers.GetSellerOrders)                 // æŸ¥çœ‹å–å®¶è®¢å•
			seller.Post("/authorize/sales", controllers.AuthorizeSales)        // æˆæƒé”€å”®
		}
		// é”€å”®è§’è‰²è·¯ç”±ç»„ï¼š
		sales := authenticated.Group("/sales", middleware.SalesOnly)
		{
			sales.Get("/orders", controllers.GetAuthorizedOrders)     // æŸ¥çœ‹å·²æˆæƒè®¢å•
			sales.Post("/drafts", controllers.CreateDraftOrder)       // åˆ›å»ºè®¢å•è‰ç¨¿
			sales.Put("/drafts/:id", controllers.UpdateDraftOrder)    // ä¿®æ”¹è‰ç¨¿
			sales.Post("/drafts/:id/submit", controllers.SubmitDraft) // æäº¤è‰ç¨¿
		}
		// å®¢æˆ·è§’è‰²è·¯ç”±ç»„ï¼š
		client := authenticated.Group("/client", middleware.ClientOnly)
		{
			client.Get("/orders", controllers.GetClientOrders)         //æŸ¥çœ‹åŒ¿åå¤„ç†çš„å–æ–¹è®¢å•
			client.Post("/orders/:id/buy", controllers.CreateBuyOrder) //å¯¹å·²æœ‰çš„å–æ–¹è®¢å•åˆ›å»ºè‡ªå·±çš„ä¹°å…¥è®¢å•
		}
		// äº¤æ˜“å‘˜è§’è‰²è·¯ç”±ç»„ï¼š
		trader := authenticated.Group("/trader", middleware.TraderOnly)
		{
			trader.Get("/orders", controllers.GetAllOrders) // æŸ¥çœ‹æ‰€æœ‰è®¢å•
		}
	}
}


æˆ‘çš„ç›¸å…³æ¨¡å‹å®šä¹‰çš„ç›¸å…³æ–‡ä»¶ï¼ˆ./models/xxx.goï¼‰å·²å‘é€ã€æˆ‘çš„./controllers/xxx.goä¸‹çš„â€œæ§åˆ¶å™¨â€æ–‡ä»¶å·²å‘é€ã€æˆ‘çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘â€”â€”æ’®åˆå¼•æ“çš„ç›¸å…³ä»£ç ï¼ˆ./service/matching.goï¼‰å·²å‘é€ã€‚
æˆ‘çš„.batæ–‡ä»¶ä¸ºæˆ‘è‡ªå®šä¹‰çš„æ‰¹å¤„ç†æ–‡ä»¶ï¼Œç”¨äºå–å¾—ç®¡ç†å‘˜æƒé™ï¼ˆé€šè¿‡é˜²ç«å¢™ï¼‰ã€ç¼–è¯‘ç¨‹åºã€å¯åŠ¨ç¨‹åºï¼Œå¹¶è¾“å‡ºè¿è¡Œæ—¥å¿—ã€æŠ¥é”™ä¿¡æ¯å’Œæ’®åˆé€»è¾‘ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰çš„æ—¥å¿—ä¿¡æ¯ã€‚å…¶å†…å®¹å¦‚ä¸‹ï¼š
@echo off
:: ...ï¼ˆä¿æŒåŸæœ‰ç®¡ç†å‘˜æƒé™æ£€æŸ¥é€»è¾‘ï¼‰

:main
cd /d "%~dp0"

:: ============== è‡ªå®šä¹‰é…ç½® ==============
set PROJECT_NAME=ebidsystem
set EXE_NAME=%PROJECT_NAME%.exe
set PORT=3000
set ENV_FILE=.env
set BIN_DIR=bin
set LOG_DIR=bin\logs

:: ============== åˆå§‹åŒ–æ—¥å¿—ç›®å½• ==============
if not exist "%LOG_DIR%" mkdir "%LOG_DIR%"
del /Q "%LOG_DIR%\service.log" 2>nul

:: ============== ç¼–è¯‘ & é…ç½® ==============
echo [%TIME%] æ­£åœ¨ç¼–è¯‘é¡¹ç›®...
go build -o "%BIN_DIR%\%EXE_NAME%" main.go || goto :error

if exist "%ENV_FILE%" (
    copy "%ENV_FILE%" "%BIN_DIR%\" >nul
    echo [%TIME%] å·²å¤åˆ¶ç¯å¢ƒæ–‡ä»¶
)

:: ============== é…ç½®é˜²ç«å¢™ ==============
echo [%TIME%] é…ç½®é˜²ç«å¢™...
set EXE_PATH=%~dp0%BIN_DIR%\%EXE_NAME%
netsh advfirewall firewall delete rule name="Allow %PROJECT_NAME% Inbound" >nul 2>&1
netsh advfirewall firewall add rule name="Allow %PROJECT_NAME% Inbound" dir=in program="%EXE_PATH%" action=allow

:: ============== å¯åŠ¨æœåŠ¡ ==============
echo [%TIME%] å¯åŠ¨æœåŠ¡ï¼ˆç«¯å£ %PORT%ï¼‰...
cd "%BIN_DIR%"
echo -------------------------------
echo å®æ—¶æ—¥å¿—ï¼ˆCtrl+Cé€€å‡ºï¼‰ï¼š

:: æ–¹æ¡ˆ1ï¼šä½¿ç”¨PowerShellåŒè¾“å‡º
powershell -Command ".\%EXE_NAME% | Tee-Object -FilePath ..\%LOG_DIR%\service.log -Append"

:: æ–¹æ¡ˆ2ï¼šåŸç”Ÿæ‰¹å¤„ç†åŒè¾“å‡ºï¼ˆé€‰å…¶ä¸€ï¼‰
:: .\%EXE_NAME% > ..\%LOG_DIR%\service.log 2>&1 & type ..\%LOG_DIR%\service.log

echo -------------------------------
pause
exit /b 0

:error
echo [é”™è¯¯] ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç ï¼
pause
exit /b 1

å¦‚æœä½ è¿˜éœ€è¦äº†è§£ä»€ä¹ˆå…·ä½“ä¿¡æ¯æˆ–å®é™…æ–‡ä»¶ï¼Œè¯·éšæ—¶å‘æˆ‘è¯¢é—®ã€‚

æˆ‘å·²åŸºæœ¬å®Œæˆæ³¨å†Œã€ç™»å½•ã€å–å®¶ï¼ˆä»¥åŠä¹°å®¶ï¼‰èº«ä»½çš„â€œåˆ›å»ºè®¢å•â€ã€â€œä¿®æ”¹è®¢å•â€ã€â€œæŸ¥çœ‹è®¢å•â€ã€â€œåˆ é™¤â€ç­‰åŠŸèƒ½ï¼Œå¹¶ä½¿ç”¨postmanå®Œæˆäº†ç»å¤§å¤šæ•°ä¸Šè¿°åŠŸèƒ½çš„æµ‹è¯•ã€‚
ä½†æˆ‘è®¤ä¸ºï¼Œæˆ‘çš„é¡¹ç›®è‡³å°‘è¿˜æœ‰å¦‚ä¸‹é—®é¢˜ï¼š
1.  é¡¹ç›®æ–‡ä»¶ç»“æ„ä¸å¤Ÿè§„èŒƒã€‚åŒ…æ‹¬ä½†ä¸é™äºï¼ˆå…¶ä»–æœªæåˆ°çš„é—®é¢˜éœ€è¦ä½ è‡ªè¡Œå¯»æ‰¾ï¼‰ï¼š
1.1 æ—¥å¿—æ–‡ä»¶ç»“æ„æ··ä¹±ã€‚æ¯”å¦‚ï¼šæ˜¯å¦åº”è¯¥æŠŠä¸šåŠ¡é€»è¾‘çš„æ—¥å¿—å•ç‹¬ä¿å­˜æˆ–å•ç‹¬è¾“å‡ºï¼Ÿæ˜¯å¦åº”è¯¥æŠŠé”™è¯¯ä¿¡æ¯çš„æ—¥å¿—å•ç‹¬ä¿å­˜æˆ–å•ç‹¬è¾“å‡ºï¼Ÿ
1.2 æ²¡æœ‰é™æ€æ–‡ä»¶çš„æ–‡ä»¶å¤¹
1.3 binæ–‡ä»¶å¤¹ä¸­çš„.envæ˜¯å¦å’Œæ ¹ç›®å½•çš„.envé‡å¤ï¼Ÿ
2. æˆ‘çš„.batæ–‡ä»¶æ˜¯å¦åº”è¯¥æ¨¡å—åŒ–ï¼ˆæˆ‘çš„æ„æ€æ˜¯ï¼šç”¨ä¸€ä¸ª.batè°ƒç”¨ä¸“é—¨è´Ÿè´£å…¶ä»–åŠŸèƒ½çš„è¯¸å¤šâ€œå­â€.batæ–‡ä»¶ï¼‰ï¼ŒæŠ‘æˆ–ä½¿ç”¨æ€§èƒ½æ›´å¥½çš„ä¸“ä¸šå·¥å…·ï¼Ÿ
3. æˆ‘çš„ä»£ç å¤ç”¨æ€§å·®ï¼Œåœ¨./controllers/ä¸‹ï¼Œä¸åŒèº«ä»½çš„è§’è‰²çš„å¾ˆå¤šå‡½æ•°é‡å¤ï¼ˆå¯èƒ½éœ€è¦æŠŠé€šç”¨ä»£ç ç§»æ¤åˆ°common.goä¸­ï¼Ÿï¼‰ã€‚
4. apiå¯èƒ½ä¸å®Œå…¨ç¬¦åˆRESTfulè§„èŒƒã€‚apiçš„å±‚æ¬¡ç»“æ„è®¾è®¡å¯èƒ½â€œä¸ç§‘å­¦â€ï¼ˆä¸ç¬¦åˆå®é™…ç”Ÿäº§çš„è§„èŒƒä¸æœŸå¾…ï¼‰ã€‚

æœ¬æ¬¡å›ç­”ï¼Œåªéœ€å›åº”æˆ‘ä¸Šé¢é—®é¢˜ï¼š
åˆ†æé—®é¢˜->æƒè¡¡åˆ©å¼Š->å¾—å‡ºç»“è®ºï¼šæ˜¯å¦ç¡®å®å­˜åœ¨é—®é¢˜->åº”è¯¥å¦‚ä½•æ”¹æ­£ï¼›
å¦‚æœè¿˜æœ‰å…¶ä»–å€¼å¾—å°½å¿«æ”¹è¿›çš„é—®é¢˜ï¼Œä¹Ÿè¯·åœ¨åˆ†æåä¸€å¹¶æŒ‡å‡ºã€‚
