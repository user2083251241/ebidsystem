# 最新架构

## 一、需要修改或删除的文件及函数

### 1. 服务层 (`services/order_service.go`)

- 删除：
  - 原 `GetOrders` 函数（由动态 `QueryCondition` 驱动）。
- 新增：
  - 策略接口 `QueryStrategy` 及具体实现（如 `SellerOrdersStrategy`）。
  - 通用查询引擎 `QueryOrders`。
  - 角色专用函数（如 `GetSellerOrders`、`GetSalesDrafts`）。

### 2. 控制器层 (`controllers/seller.go`, `controllers/sales.go` 等)

- 修改：
  - 所有调用旧 `GetOrders` 的控制器函数，改为调用角色专用函数（如 `GetSellerOrders`）。
  - 示例：`sellerController.GetOrders` → `sellerController.GetSellerOrders`。
- 删除：
  - 控制器中直接操作数据库的代码（如 `db.Where(...)`）。

### 3. 模型层 (`models/order.go`)

- 调整：
  - 确保 `LiveOrder` 和 `DraftOrder` 的字段与策略查询条件匹配（如 `direction`、`status`）。
  - 添加必要的关联字段（如 `DraftBySales`、`ApprovedBy`）。

### 4. 中间件 (`middleware/auth.go`)

- 新增：
  - 策略权限校验逻辑（如检查用户角色是否匹配策略）。

### 5. 工具类 (`utils/validation.go`)

- 调整：
  - 校验函数支持新的请求结构体（如 `CreateSellerOrderRequest`）。

## 二、最终文件结构

```
backend/
├── bin/                   # 编译输出
├── config/                # 配置管理
│   └── database.go        # 数据库初始化
├── controllers/           # 控制器层
│   ├── seller.go          # 卖家控制器
│   ├── sales.go           # 销售控制器
│   ├── client.go          # 客户控制器
│   ├── trader.go          # 交易员控制器
│   └── common.go          # 通用工具（错误响应）
├── middleware/            # 中间件
│   ├── auth.go            # 权限校验
│   └── jwt.go             # JWT 处理
├── models/                # 数据模型
│   ├── user.go            # 用户模型
│   ├── order.go           # 订单基类及子类
│   └── authorization.go   # 授权模型
├── services/              # 服务层
│   ├── order_service.go   # 订单服务（核心逻辑）
│   └── order_query.go     # 查询策略接口及实现
├── utils/                 # 工具类
│   ├── validation.go      # 校验工具
│   └── ptr.go             # 指针工具
├── routes/                # 路由定义
│   └── api.go             # API 路由注册
└── main.go                # 应用入口
```

## 三、最新项目架构描述（600字）

### 1. 架构设计原则

本系统采用 分层架构 和 策略模式，严格遵循 SOLID 原则，具体体现为：

- 单一职责原则 (SRP)：每层、每个模块、每个函数仅处理单一职责（如控制器仅解析请求，服务层处理业务逻辑）。
- 开闭原则 (OCP)：通过策略接口扩展查询逻辑，无需修改核心引擎。
- 依赖倒置原则 (DIP)：高层模块（控制器）依赖抽象（服务接口），而非具体实现。

### 2. 核心模块划分

#### (1) 控制器层 (Controllers)

- 职责：处理 HTTP 请求/响应，解析参数，调用服务层。
- 关键设计：
  - 通过构造函数注入服务实例（如 `NewSellerController(orderService)`）。
  - 使用统一错误响应格式（`ErrorResponse`）。
- 示例：
  - `sellerController.GetSellerOrders`：调用 `orderService.GetSellerOrders`，返回卖家订单列表。

#### (2) 服务层 (Services)

- 职责：实现核心业务逻辑，包括订单创建、查询、状态管理等。
- 关键设计：
  - 策略模式：通过 `QueryStrategy` 接口定义不同角色的查询逻辑（如卖家查卖出订单，销售查草稿）。
  - 通用查询引擎：`QueryOrders` 函数接收策略实例，动态构建查询条件。
  - 角色专用函数：如 `GetSellerOrders` 硬编码卖家权限校验，确保安全性。
- 示例：
  - `SellerOrdersStrategy`：实现卖家订单查询的 `WHERE` 条件（`user_id = ? AND direction = 'sell'`）。

#### (3) 模型层 (Models)

- 职责：定义数据结构及数据库关系。
- 关键设计：
  - 组合模式：`BaseOrder` 包含公共字段（如 `Symbol`、`Quantity`），`LiveOrder` 和 `DraftOrder` 组合基类并扩展特有字段。
  - 状态机管理：通过 `status` 字段控制订单生命周期（如 `draft → pending_approval → pending`）。

#### (4) 中间件 (Middleware)

- 职责：处理跨切面逻辑（如身份验证、权限校验）。
- 关键设计：
  - JWT 解析：从请求头提取 Token，验证用户身份。
  - 角色校验：在路由注册时通过 `middleware.RoleRequired("seller")` 限制访问。

### 3. 数据流与交互流程

1. HTTP 请求到达路由：  
   - 路由层 (`routes/api.go`) 根据 URL 和 HTTP 方法分发到对应控制器。
2. 控制器解析请求：  
   - 解析请求体（如 `c.BodyParser(&req)`），调用服务层。
3. 服务层执行业务逻辑：  
   - 根据角色选择查询策略（如 `SellerOrdersStrategy`），调用通用引擎 `QueryOrders`。
4. 数据库操作：  
   - 服务层通过 GORM 操作数据库，返回标准化 DTO。
5. 返回响应：  
   - 控制器构造 JSON 响应，包含成功数据或错误信息。

### 4. 安全性设计

- 权限硬编码：服务层函数（如 `CreateSellerOrder`）直接校验用户角色，防止横向越权。
- JWT 校验：中间件强制验证 Token，拒绝非法请求。
- 脱敏处理：DTO 根据角色隐藏敏感字段（如对客户隐藏订单数量）。

### 5. 扩展性与维护性

- 策略模式扩展：新增查询场景只需实现 `QueryStrategy` 接口（如 `TraderAllOrdersStrategy`）。
- 校验工具复用：通过 `utils.ValidateStruct` 统一校验请求参数。
- 依赖注入管理：通过 `NewOrderService(db)` 解耦数据库依赖，便于单元测试。

### 6. 企业级优势

- 高可维护性：模块化设计，各层职责清晰，降低代码耦合。
- 灵活扩展：策略模式支持快速适配新业务需求。
- 强安全性：硬编码权限校验和 JWT 中间件保障系统安全。
- 符合规范：严格遵循 RESTful API 设计，响应格式标准化。

## 总结

通过混合方案，系统在复用性、安全性和扩展性之间取得平衡，既避免重复代码，又确保业务逻辑清晰可控。分层架构和策略模式的结合，使得代码易于维护和扩展，完全符合企业级金融系统的开发标准。
